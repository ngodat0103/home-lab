---
- name: Create GitHub runner user
  user:
    name: github-runner
    shell: /usr/sbin/nologin
    system: true
    create_home: false

- name: Create install dir
  file:
    path: "{{ github_runner_install_dir }}"
    state: directory
    owner: github-runner
    group: github-runner
    mode: "0755"

- name: Download GitHub runner {{ github_runner_version }}
  get_url:
    url: "https://github.com/actions/runner/releases/download/v{{ github_runner_version }}/actions-runner-linux-x64-{{ github_runner_version }}.tar.gz"
    dest: "{{ github_runner_install_dir }}/runner.tar.gz"
    mode: "0644"

- name: Extract runner
  unarchive:
    src: "{{ github_runner_install_dir }}/runner.tar.gz"
    dest: "{{ github_runner_install_dir }}"
    remote_src: true
    owner: github-runner
    group: github-runner

- name: Install runner dependencies
  apt:
    name:
      - libicu70
    state: present
  register: _deps
  failed_when: false  # tolerate if different Ubuntu release (libicu version may vary)

- name: Configure runner (if token provided)
  shell: |
    sudo -u github-runner {{ github_runner_install_dir }}/config.sh --unattended           --url "{{ github_repo_url }}"           --token "{{ github_runner_token }}"           --labels "{{ github_runner_labels }}"           --name "{{ github_runner_name }}"           --replace
  args:
    chdir: "{{ github_runner_install_dir }}"
  when: github_runner_token | length > 0

- name: Install service
  shell: |
    cd {{ github_runner_install_dir }}
    ./svc.sh install github-runner
  args:
    creates: /etc/systemd/system/actions.runner.service

- name: Enable and start service
  systemd:
    name: actions.runner.service
    enabled: true
    state: started
