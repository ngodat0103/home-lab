---
- name: Hephaestus â€“ Build/CI node bootstrap
  hosts: hephaestus
  become: true
  vars_files:
    - group_vars/hephaestus.yml
  roles:
    - role: common
    - role: golang
    - role: docker
    - role: gitlab_runner
  tasks:
   - name: Ensure GitLab host is in /etc/hosts
     ansible.builtin.lineinfile:
        path: /etc/hosts
        line: '192.168.1.121 gitlab.datrollout.dev'
        state: present
   - name: Register GitLab Runner
     vars:
      gitlab_runner_url: https://gitlab.datrollout.dev
      gitlab_runner_tags: ["ubuntu-2204"]
      gitlab_runner_executor: docker
      gitlab_runner_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37333331623832393336646462306337613734313465613135313936343762623562336235376434
          6663663138646265653133643465383133393332393766610a643630303937633532636531313039
          61643339356636646431303032646638333537373730343337663061663763663162646663343364
          3434396435633138330a333037393331373135333932333733386233383861623335306530353339
          65316237373631623335646532316437353433616331306663373633333632363462333063323233
          31343033356437366436646363643030633732396231323239643533616231373432393438636134
          313532366234376239656134643239396364
     ansible.builtin.command:
      cmd: >
          gitlab-runner register
          --non-interactive
          --url "{{ gitlab_runner_url }}"
          --token "{{ gitlab_runner_token }}"
          --executor "{{gitlab_runner_executor}}"
          --docker-image "ubuntu-2204"
          --docker-privileged
          --docker-volumes "/certs/client"
          --docker-volumes "/cache"