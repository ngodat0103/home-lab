- name: manage vaultwarden
  hosts: ubuntu-server
  become: yes
  vars:
    UID: 1002
    GID: 1002
    SHELL: '/bin/bash'
    HOME_DIR: '/mnt/data2/docker/vaultwarden_data'
    domain: "bitwarden.datrollout.dev"
  tasks:
  - name: Create vaultwarden user
    ansible.builtin.user:
      name: vaultwarden
      state: present
      shell: "{{SHELL}}"
      uid: "{{UID}}"
      home: "/mnt/data2/docker/vaultwarden_data"
      create_home: false
      password: '!' # not allow password login
  - name: Create vaultwarden group
    ansible.builtin.group:
      name: vaultwarden
      state: present
      gid: "{{GID}}"
  - name: Make sure vaultwarden is running
    vars:
     DATABASE_HOST: "192.168.99.2"
     DATABASE_NAME: "vaultwarden"
     DATABASE_PORT: "5432"
     ADMIN_TOKEN: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      36343435643735616635343166623463303432326161353036626462353964376461363566316337
      3536663065636263313238633233653864626564373837340a353831353830373338383364393362
      62633462656338393963633639646238313965626133623561346334656534386538626664373833
      6439613764393462360a616461663535643833373438353133343038323738653066646161333362
      37646463363435376534383565346333336463366361626332313830386330633135333364346439
      33346332386337643439336138623038653266646164646363343130393335613063353164363366
      34616161346363323065323835613537613663653637343435356661393465316132376265313366
      66313639643136643332
     DATABASE_USER: "vaultwarden"
     DATABASE_PASSWORD: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      62393836366564376431653137666164326465363531303962353666373935383733613461333337
      6131623861306562613132333034303433353063636433640a623561383135666331353933653530
      34363161643938373033663130353234303363663962306466626137363065333565663065656366
      3863343362626136620a623238356139663033323331663562653666613263313965616135303839
      30343637663836623063366439656533336339313732326362396632336336616135
     DATA_PATH: "/mnt/data2/docker/vaultwarden_data"
    ansible.builtin.docker_container:
      labels:
        com.github.ngodat0103.service: vaultwarden
        traefik.enable: "true"
        traefik.http.routers.bitwarden.rule: "Host(`{{domain}}`)"
        traefik.http.routers.bitwarden.tls.certResolver: "letsencrypt"
        traefik.http.routers.bitwarden.entrypoints: "websecure,web"
        traefik.http.routers.bitwarden.tls: "true"
      name: vaultwarden
      image: vaultwarden/server:1.34.3-alpine@sha256:d70118b9dafb8588ee2651ceb5df68db27dcbd8e18467722010644ba48d5d6d6
      user: "{{UID}}:{{GID}}"
      state: started
      restart_policy: always
      env:
        DATABASE_URL: "postgresql://{{DATABASE_USER}}:{{DATABASE_PASSWORD}}@{{DATABASE_HOST}}:{{DATABASE_PORT}}/{{DATABASE_NAME}}"
        ADMIN_TOKEN: "{{ADMIN_TOKEN}}"
        SIGNUPS_ALLOWED: 'false'
        PUSH_ENABLED: 'true'
        PUSH_INSTALLATION_ID: 54e25694-eefc-48fe-b102-b07c01008c8e
        PUSH_INSTALLATION_KEY: rVnt5Qe79y28aOEzyIqR
        TZ: Asia/Ho_Chi_Minh
      networks:
      - name: runtime-network
        ipv4_address: 192.168.30.3
      volumes:
       - "{{DATA_PATH}}:/data/"
  - name: Make sure postgresql-client is installed
    ansible.builtin.import_role:
      name: postgresql-client
  - name: Make sure backup.sh is present
    become_user: vaultwarden
    vars:
     PGPASSWORD: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        30353563303133323263613432653038323833643937656438656338336162323466613135636164
        3063646331356662356638366362343761636365623662620a363732313630353830643563623261
        35663862623139343933316162663034373366316465633437613364336533343634316334303837
        3463613536326438350a343337623166623863356339663336616666303831323238376431313566
        32376433346533323462663333353332303962363433626435656639653130633835
    ansible.builtin.copy:
     content: |
        #!/bin/bash
        set -e
        cd ~
        export PGPASSWORD="{{PGPASSWORD}}"
        pg_dump -d vaultwarden -h 192.168.99.2 -U vaultwarden > full-backup.sql
        tar -cf vaultwarden-backup-latest.tar .
        mv vaultwarden-backup-latest.tar /mnt/recovery/cloud
        chmod 600 /mnt/recovery/cloud/vaultwarden-backup-latest.tar
     dest: "{{HOME_DIR}}/backup.sh"
     mode: "500"
  - name: Cron Backup
    become_user: vaultwarden
    ansible.builtin.cron:
      name: "Daily backup at 1AM"
      state: present
      job: ~/backup.sh
      hour: 1
      minute: 0