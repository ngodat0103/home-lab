---
- name: Add Kubernetes apt key
  apt_key:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    state: present

- name: Add Kubernetes apt repository
  apt_repository:
    repo: "deb https://apt.kubernetes.io/ kubernetes-xenial main"
    state: present
    filename: kubernetes

- name: Install kubectl (latest or pinned)
  apt:
    name: "{{ 'kubectl=' + kubectl_version + '-00' if kubectl_version|length > 0 else 'kubectl' }}"
    state: present
    update_cache: true

- name: Install Helm (script) when helm_version empty (latest)
  shell: |
    set -e
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  when: helm_version | length == 0

- name: Install Helm (pinned) when helm_version set
  get_url:
    url: "https://get.helm.sh/helm-v{{ helm_version }}-linux-amd64.tar.gz"
    dest: "/tmp/helm-v{{ helm_version }}-linux-amd64.tar.gz"
  when: helm_version | length > 0

- name: Extract Helm (pinned)
  unarchive:
    src: "/tmp/helm-v{{ helm_version }}-linux-amd64.tar.gz"
    dest: /tmp
    remote_src: true
  when: helm_version | length > 0

- name: Move helm binary (pinned)
  copy:
    src: /tmp/linux-amd64/helm
    dest: /usr/local/bin/helm
    mode: "0755"
    remote_src: true
  when: helm_version | length > 0

- name: Install k9s
  unarchive:
    src: "https://github.com/derailed/k9s/releases/download/v{{ k9s_version }}/k9s_Linux_amd64.tar.gz"
    dest: /usr/local/bin
    remote_src: true
    extra_opts: [--no-anchored, "k9s"]
    creates: /usr/local/bin/k9s
