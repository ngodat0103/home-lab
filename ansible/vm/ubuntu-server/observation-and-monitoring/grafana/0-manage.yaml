# Version grafana collection: 5.6

- name: Manage Grafana
  hosts: ubuntu-server
  become: yes
  vars:
   default_influxdb_datasource_name: 'pve-master'
   grafana_alert_resources: 
    contactPoints:
      - orgId: 1
        name: Email to Mine
        receivers:
          - uid: mine
            type: email
            settings:
              addresses: ngovuminhdat@gmail.com
              singleEmail: true
   grafana_provisioning_sync: true
   grafana_dashboards:
       # https://grafana.com/grafana/dashboards/12966-mo-server/
    - dashboard_id: 12966
      revision_id: 1
      datasource: "{{default_influxdb_datasource_name}}"
   grafana_security:
    admin_user: akira
    admin_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38656232333364343263613261306536306335383162363135646232636134393766323463613738
          3933646637623131646263373131313230386663373037340a306637646635353436623730666465
          35643634356537333438613632396364316333343864303466346339336135313766363763653539
          3262396564663334620a613764633737376538383932373761643639396237626263353232666166
          3664
   influxdb_api_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34316635353938656434326637383564353061393465656564653435636637386466373261386461
          6337353665383431316138313133346432643231623433650a326431663761653266653265326137
          63613861353630623131626164353230313736623731616136353765313065316238373834653737
          6465613736346636620a383237346263643038373261346430396665396130316561646233306137
          31396236653632363436376539633232366138326532346230613331386138353764613737316566
          32356564666533643232643537323263363534656136343063366337653465393738613062326165
          62313266373132303562336465653432613362313562366636646263336362633138646533356465
          34396365333037653965643565356330363839353030383561663764313239376437383065626565
          6663
   grafana_datasources:
    - name: "{{default_influxdb_datasource_name}}"
      type: influxdb
      url: 'http://127.0.0.1:8086'
      basicAuth: false
      jsonData:
       httpHeaderName1: Authorization
      secureJsonData:
       httpHeaderValue1: "Token {{influxdb_api_token}}"
      database: proxmox # Need to create database in influxdb first using: influxdb3 create database pve-master
  roles:
   - name: grafana.grafana.grafana
  tasks:
   - name: Configure smtp
     tags: configure-email
     vars:
      smtp_username: 21521935@gm.uit.edu.vn
      smtp_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63383162313666393632373363303066316533353836353738363637373534326563333934633066
          6331626131376534316663633334363964623135366366370a623536613163373231376566323061
          63326466663932656230653362343936353433306431313238346366613638386331633436633932
          6537376661323739300a333931353837643661383531343533623030393631346561343338353638
          65663939636463343638623731336266336639303334653865313138616233623237
     ansible.builtin.blockinfile:
      dest: /etc/grafana/grafana.ini
      block: "{{lookup('ansible.builtin.template','smtp.ini.j2')}}"
     notify: Restart grafana