- name: Make sure postgresql-16 is installed
  hosts: postgresql-16
  become: yes
  handlers:
   - name: reload
     ansible.builtin.systemd:
      name: postgresql@16-main
      state: reloaded
  pre_tasks:
   - name: Add postgresql-16 key
     ansible.builtin.apt_key:
      url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
      state: present
      keyring: /etc/apt/keyrings/postgresql.gpg
   - name: Add postgresql-16 repository
     ansible.builtin.apt_repository:
      repo: "deb [signed-by=/etc/apt/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt {{ansible_distribution_release}}-pgdg main"
      state: present
   - name: Install postgresql-16
     ansible.builtin.apt:
      update_cache: true
      package:
        - postgresql-16
        - postgresql-contrib-16
  tasks:
  - name: Setup Host based authentication
    tags: ['setup-hba']
    vars:
      PG_HBA_PATH: '/etc/postgresql/16/main/pg_hba.conf'
    notify: reload
    ansible.builtin.copy:
      src: pg_hba.conf
      dest: "{{PG_HBA_PATH}}"
      mode: "400"
      owner: postgres
  - name: Make sure to listen only local and runtime network interface
    tags: ['setup-interfaces']
    ansible.builtin.lineinfile:
      dest: "/etc/postgresql/16/main/postgresql.conf"
      regexp: "^listen_addresses"
      line: "listen_addresses = 'localhost,192.168.99.2'"