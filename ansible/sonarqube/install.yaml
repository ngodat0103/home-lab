---
# file: sonarqube-prereqs.yml
# Usage:
#   ansible-playbook -i your_inventory sonarqube-prereqs.yml -K
# Optional vars:
#   sonarqube_user=sonarqube sonarqube_systemd_service_name=sonarqube

- name: Installation Sonarqube (Ubuntu 22.04)
  hosts: sonarqube
  vars:
    sonarqube_user: "sonarqube"
    sonarqube_systemd_service_name: ""
    required_vm_max_map_count: 524288
    required_fs_file_max: 131072
    required_nofile: 131072
    required_nproc: 8192
    sysctl_dropin_path: "/etc/sysctl.d/99-sonarqube.conf"
    limits_dropin_path: "/etc/security/limits.d/99-sonarqube.conf"
    sonarqube_version: "25.10.0.114319"
    sonarqube_zip_url: "https://binaries.sonarsource.com/Distribution/sonarqube/sonarqube-{{ sonarqube_version }}.zip"
    sonarqube_install_dir: "/opt"
    sonarqube_target_dir: "{{ sonarqube_install_dir }}/sonarqube-{{ sonarqube_version }}"
    sonarqube_symlink: "{{ sonarqube_install_dir }}/sonarqube"
    sonarqube_group: "sonarqube"
  pre_tasks:
  ########################################################################
  # 1️⃣ Java Runtime Environment
  ########################################################################
  - name: Ensure OpenJDK 17 is installed
    apt:
      name: openjdk-17-jdk
      state: present
      update_cache: yes

  - name: Verify Java installation
    command: java -version
    register: java_version
    changed_when: false
    failed_when: "'17' not in java_version.stderr and '17' not in java_version.stdout"

  ########################################################################
  # 2️⃣ Kernel and System Limits (Elasticsearch prerequisites)
  ########################################################################
  - name: Ensure required packages for managing limits (pam) are present
    apt:
      name: [ "libpam-modules", "libpam-modules-bin" ]
      state: present
      update_cache: yes

  - name: Set vm.max_map_count (persistent)
    ansible.posix.sysctl:
      name: vm.max_map_count
      value: "{{ required_vm_max_map_count }}"
      sysctl_file: "{{ sysctl_dropin_path }}"
      state: present
      reload: yes

  - name: Set fs.file-max (persistent)
    ansible.posix.sysctl:
      name: fs.file-max
      value: "{{ required_fs_file_max }}"
      sysctl_file: "{{ sysctl_dropin_path }}"
      state: present
      reload: yes

  - name: Create limits.d file for SonarQube user
    copy:
      dest: "{{ limits_dropin_path }}"
      owner: root
      group: root
      mode: '0644'
      content: |
        # SonarQube requirements
        {{ sonarqube_user }} soft nofile {{ required_nofile }}
        {{ sonarqube_user }} hard nofile {{ required_nofile }}
        {{ sonarqube_user }} soft nproc  {{ required_nproc }}
        {{ sonarqube_user }} hard nproc  {{ required_nproc }}

  - name: Ensure pam_limits is enabled in /etc/pam.d/common-session
    lineinfile:
      path: /etc/pam.d/common-session
      regexp: '^\s*session\s+required\s+pam_limits\.so'
      line: 'session required pam_limits.so'
      state: present

  - name: Ensure pam_limits is enabled in /etc/pam.d/common-session-noninteractive
    lineinfile:
      path: /etc/pam.d/common-session-noninteractive
      regexp: '^\s*session\s+required\s+pam_limits\.so'
      line: 'session required pam_limits.so'
      state: present

  ########################################################################
  # 3️⃣ Optional systemd override (if SonarQube is a service)
  ########################################################################
  - name: Optionally set systemd service limits (if service name provided)
    when: sonarqube_systemd_service_name | length > 0
    block:
    - name: Create systemd override directory
      file:
        path: "/etc/systemd/system/{{ sonarqube_systemd_service_name }}.service.d"
        state: directory
        mode: '0755'

    - name: Write systemd override for limits
      copy:
        dest: "/etc/systemd/system/{{ sonarqube_systemd_service_name }}.service.d/override.conf"
        mode: '0644'
        content: |
          [Service]
          LimitNOFILE={{ required_nofile }}
          LimitNPROC={{ required_nproc }}

    - name: Reload systemd daemon
      command: systemctl daemon-reload

  ########################################################################
  # 4️⃣ Verification & Info
  ########################################################################
  - name: Show effective sysctl values
    command: sysctl -n vm.max_map_count fs.file-max
    register: sysctl_out
    changed_when: false

  - name: Print summary
    debug:
      msg: |
        ✅ Java version check: OK ({{ java_version.stderr | default(java_version.stdout) | regex_search('version.*') }})
        ✅ vm.max_map_count = {{ sysctl_out.stdout_lines[0] | default('unknown') }}
        ✅ fs.file-max      = {{ sysctl_out.stdout_lines[1] | default('unknown') }}
        ✅ Limits for '{{ sonarqube_user }}':
            nofile ≥ {{ required_nofile }}
            nproc  ≥ {{ required_nproc }}
        To verify:
          sudo -iu {{ sonarqube_user }} bash -lc 'ulimit -n; ulimit -u'
  tasks:
  - name: Install unzip if missing
    apt:
      name: unzip
      state: present
      update_cache: yes
  - name: Ensure SonarQube group exists
    group:
      name: "{{ sonarqube_group }}"
      state: present
  - name: Ensure SonarQube user exists
    user:
      name: "{{ sonarqube_user }}"
      group: "{{ sonarqube_group }}"
      shell: /bin/bash
      create_home: yes
      home: "/home/{{ sonarqube_user }}"
      state: present
  - name: Create installation directory
    file:
      path: "{{ sonarqube_install_dir }}"
      state: directory
      mode: '0755'
  - name: Download SonarQube ZIP
    get_url:
      url: "{{ sonarqube_zip_url }}"
      dest: "/tmp/sonarqube-{{ sonarqube_version }}.zip"
      mode: '0644'
      timeout: 60
    register: download_result

  - name: Extract SonarQube to /opt
    unarchive:
      src: "/tmp/sonarqube-{{ sonarqube_version }}.zip"
      dest: "{{ sonarqube_install_dir }}"
      remote_src: yes
      creates: "{{ sonarqube_target_dir }}"
    notify: Fix permissions

  ########################################################################
  # 4️⃣ Manage symlink and permissions
  ########################################################################
  - name: Update /opt/sonarqube symlink
    file:
      src: "{{ sonarqube_target_dir }}"
      dest: "{{ sonarqube_symlink }}"
      state: link
      force: true

  - name: Ensure ownership of SonarQube directories
    file:
      path: "{{ sonarqube_target_dir }}"
      owner: "{{ sonarqube_user }}"
      group: "{{ sonarqube_group }}"
      recurse: true
      state: directory

  ########################################################################
  # 5️⃣ Verify installation
  ########################################################################
  - name: Check SonarQube directory structure
    stat:
      path: "{{ sonarqube_target_dir }}/bin"
    register: sonar_dir
  - name: Print result summary
    debug:
      msg: |
        ✅ SonarQube {{ sonarqube_version }} installed at {{ sonarqube_target_dir }}
        ✅ Symlink created at {{ sonarqube_symlink }}
        ✅ Owned by {{ sonarqube_user }}:{{ sonarqube_group }}
        ✅ Contains bin dir: {{ sonar_dir.stat.exists }}
  handlers:
  - name: Fix permissions
    file:
      path: "{{ sonarqube_target_dir }}"
      owner: "{{ sonarqube_user }}"
      group: "{{ sonarqube_group }}"
      recurse: true
      state: directory
