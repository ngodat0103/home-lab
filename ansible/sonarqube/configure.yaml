---
- name: Configure SonarQube and systemd service
  hosts: sonarqube
  vars:
    sonar_jdbc_url: "jdbc:postgresql://192.168.99.2/sonarqube?currentSchema=public"
    sonar_jdbc_username: "sonarqube"
    sonar_jdbc_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30323934333561376566646234623538656265613961633866636537393566343439313462373135
          3438346135303663326365666637363936393932393263360a386431386533366330343532353564
          64396439376437633635613361636438333936333033616531383164346330326165363666363739
          6463363639373637340a306661633933343763663938383464376533386536303565646166666261
          3365

    # --- Paths and runtime user ---
    sonarqube_home: "/opt/sonarqube" # symlink created by your install play
    sonarqube_user: "sonarqube"
    sonarqube_group: "sonarqube"

    # --- Java 17 path (auto if default java is 17; otherwise set explicitly) ---
    # Example for Ubuntu OpenJDK 17:
    java_bin: "/usr/lib/jvm/java-17-openjdk-amd64/bin/java"

    # --- Limits (match your prereqs play) ---
    limit_nofile: 131072
    limit_nproc: 8192

    sonar_properties_file: "{{ sonarqube_home }}/conf/sonar.properties"
    sonar_service_name: "sonarqube"
    sonar_bin_dir: "{{ sonarqube_home }}/bin/linux-x86-64"
    sonar_sh: "{{ sonar_bin_dir }}/sonar.sh"

  tasks:
  - name: Ensure SonarQube home exists
    stat:
      path: "{{ sonarqube_home }}"
    register: sq_home

  - name: Fail if SonarQube is not installed at {{ sonarqube_home }}
    fail:
      msg: "SonarQube not found at {{ sonarqube_home }}. Run your install play first."
    when: not sq_home.stat.exists

  - name: Ensure conf directory exists
    file:
      path: "{{ sonarqube_home }}/conf"
      state: directory
      owner: "{{ sonarqube_user }}"
      group: "{{ sonarqube_group }}"
      mode: "0755"

  - name: Ensure sonar.properties exists (create if missing)
    file:
      path: "{{ sonar_properties_file }}"
      state: touch
      owner: "{{ sonarqube_user }}"
      group: "{{ sonarqube_group }}"
      mode: "0644"

  # --- Set sonar.jdbc.url ---
  - name: Configure sonar.jdbc.url
    lineinfile:
      path: "{{ sonar_properties_file }}"
      regexp: '^\s*sonar\.jdbc\.url\s*='
      line: "sonar.jdbc.url={{ sonar_jdbc_url }}"
      create: yes
      backup: yes

  # --- Optionally set sonar.jdbc.username ---
  - name: Configure sonar.jdbc.username (if provided)
    lineinfile:
      path: "{{ sonar_properties_file }}"
      regexp: '^\s*sonar\.jdbc\.username\s*='
      line: "sonar.jdbc.username={{ sonar_jdbc_username }}"
      create: yes
    when: sonar_jdbc_username | length > 0

  # --- Optionally set sonar.jdbc.password ---
  - name: Configure sonar.jdbc.password (if provided)
    lineinfile:
      path: "{{ sonar_properties_file }}"
      regexp: '^\s*sonar\.jdbc\.password\s*='
      line: "sonar.jdbc.password={{ sonar_jdbc_password }}"
      create: yes
    when: sonar_jdbc_password | length > 0

  - name: Ensure ownership of SonarQube tree
    file:
      path: "{{ sonarqube_home }}"
      owner: "{{ sonarqube_user }}"
      group: "{{ sonarqube_group }}"
      recurse: true
      state: directory

  # --- Systemd service for auto-start on boot ---
  - name: Create systemd unit for SonarQube
    copy:
      dest: "/etc/systemd/system/{{ sonar_service_name }}.service"
      owner: root
      group: root
      mode: "0644"
      content: |
        [Unit]
        Description=SonarQube Service
        After=network.target syslog.target
        Wants=network-online.target

        [Service]
        Type=forking
        User={{ sonarqube_user }}
        Group={{ sonarqube_group }}
        LimitNOFILE={{ limit_nofile }}
        LimitNPROC={{ limit_nproc }}
        # Ensure Java 17 path if needed:
        Environment=SONAR_JAVA_PATH={{ java_bin }}
        # If you prefer JAVA_HOME instead, use:
        # Environment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        # Environment=PATH=/usr/lib/jvm/java-17-openjdk-amd64/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin

        ExecStart={{ sonar_sh }} start
        ExecStop={{ sonar_sh }} stop
        Restart=on-failure
        SuccessExitStatus=143

        # Hardening (optional)
        NoNewPrivileges=true
        PrivateTmp=true
        ProtectSystem=full

        [Install]
        WantedBy=multi-user.target

  - name: Reload systemd
    command: systemctl daemon-reload

  - name: Enable SonarQube service on boot
    systemd:
      name: "{{ sonar_service_name }}"
      enabled: true

  - name: Start (or restart) SonarQube
    systemd:
      name: "{{ sonar_service_name }}"
      state: restarted

  - name: Show service status hint
    debug:
      msg: |
        SonarQube service '{{ sonar_service_name }}' enabled and started.
        Check logs with:
          journalctl -u {{ sonar_service_name }} -f
        or:
          tail -f {{ sonarqube_home }}/logs/sonar.log